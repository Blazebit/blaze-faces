<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:b="http://blazebit.com/faces"
	template="../templates/ui.xhtml">
    
    <ui:define name="head">
        <style type="text/css">
            .messageInput {
                width:400px;
            }
            
            .publicColumn {
               width:80%;
            }
            
            .usersColumn {
                width:20%;
            }
            
            .vtop {
                vertical-align: top;
            }
            
            .chatlogs {
                height:200px;
                overflow:auto;
                padding: 0.5em 1em 0.5em 0.5em;
            }
            
            .usersList {
                height:200px;
                overflow:auto;
            }
            
            .usersList ul {
                list-style-type: none;
                padding-left:10px;
            }
            
            .usersList ul li {
                margin-bottom: 2px;
            }
            
            .usersList .ui-button-text {
                padding:0;
            }
        </style>
        
        <script type="text/javascript">
            //<![CDATA[
            function handleMessage(data) {
                var chatContent = $(BlazeFaces.escapeClientId('form:public'));
                chatContent.append(data + '<br />');
                
                //keep scroll
                chatContent.scrollTop(chatContent.height());
            }
            //]]>
        </script>
    </ui:define>

	<ui:define name="content">

			<h1 class="title ui-widget-header ui-corner-all">BlazePush - Chat</h1>
			<div class="entry">
			<p>Chat is a simple push based application created with BlazePush.</p>
            
            <b:growl id="growl" showDetail="true" />
            
            <h:form id="form">
                
                <b:fieldset id="container" legend="BlazeChat" toggleable="true">
                    
                    <h:panelGroup rendered="#{chatView.loggedIn}">
                        
                        <h:panelGrid columns="2" columnClasses="publicColumn,usersColumn" style="width:100%">
                            <b:outputPanel id="public" layout="block" styleClass="ui-corner-all ui-widget-content chatlogs"/>
                            
                            <b:dataList id="users" var="user" value="#{chatUsers.users}" styleClass="usersList">
                                <f:facet name="header">
                                    Users
                                </f:facet>

                                <b:commandButton title="Chat" icon="ui-icon-comment" oncomplete="pChat.show()" update=":form:privateChatContainer">
                                    <f:setPropertyActionListener value="#{user}" target="#{chatView.privateUser}" />
                                </b:commandButton>
                                #{user}
                            </b:dataList>
                        </h:panelGrid>
                        
                        <b:separator />
                        
                        <b:inputText value="#{chatView.globalMessage}" styleClass="messageInput" />
                        <b:spacer width="5" />
                        <b:commandButton value="Send" actionListener="#{chatView.sendGlobal}" oncomplete="$('.messageInput').val('').focus()"/>
                        <b:spacer width="5" />
                        <b:commandButton value="Disconnect" actionListener="#{chatView.disconnect}" global="false" update="container" />
                    </h:panelGroup>
                    
                    <h:panelGroup rendered="#{not chatView.loggedIn}" >
                        Username: <b:inputText value="#{chatView.username}" />
                
                        <b:spacer width="5" />
                        <b:commandButton value="Login" actionListener="#{chatView.login}" update="container" 
                                         icon="ui-icon-person" />
                    </h:panelGroup>
                    
                </b:fieldset>
                
                <b:dialog widgetVar="pChat" header="Private Chat" modal="true" showEffect="fade" hideEffect="fade">
                    <h:panelGrid id="privateChatContainer" columns="2" columnClasses="vtop,vtop">
                        <b:outputLabel for="pChatInput" value="To: #{chatView.privateUser}" />
                        <b:inputTextarea id="pChatInput" value="#{chatView.privateMessage}" rows="5" cols="30" />
                        
                        <b:spacer />
                        <b:commandButton value="Send" actionListener="#{chatView.sendPrivate}" oncomplete="pChat.hide()" />
                    </h:panelGrid>
                </b:dialog>
                             
            </h:form>
            
            <b:socket onMessage="handleMessage" channel="/chat" autoConnect="false" widgetVar="subscriber">
                <b:ajax event="message" update=":form:users" />
            </b:socket>

            <h3>Source</h3>
            <b:tabView>
                <b:tab title="chat.xhtml">
                    <pre name="code" class="xml">
&lt;b:growl id="growl" showDetail="true" /&gt;

&lt;h:form id="form"&gt;

    &lt;b:fieldset id="container" legend="BlazeChat" toggleable="true"&gt;

        &lt;h:panelGroup rendered="\#{chatView.loggedIn}"&gt;

            &lt;h:panelGrid columns="2" columnClasses="publicColumn,usersColumn" style="width:100%"&gt;
                &lt;b:outputPanel id="public" layout="block" styleClass="ui-corner-all ui-widget-content chatlogs"/&gt;

                &lt;b:dataList id="users" var="user" value="\#{chatUsers.users}" styleClass="usersList"&gt;
                    &lt;f:facet name="header"&gt;
                        Users
                    &lt;/f:facet&gt;

                    &lt;b:commandButton title="Chat" icon="ui-icon-comment" oncomplete="pChat.show()" update=":form:privateChatContainer"&gt;
                        &lt;f:setPropertyActionListener value="\#{user}" target="\#{chatView.privateUser}" /&gt;
                    &lt;/b:commandButton&gt;
                    \#{user}
                &lt;/b:dataList&gt;
            &lt;/h:panelGrid&gt;

            &lt;b:separator /&gt;

            &lt;b:inputText value="\#{chatView.globalMessage}" styleClass="messageInput" /&gt;
            &lt;b:spacer width="5" /&gt;
            &lt;b:commandButton value="Send" actionListener="\#{chatView.sendGlobal}" oncomplete="$('.messageInput').val('').focus()"/&gt;
            &lt;b:spacer width="5" /&gt;
            &lt;b:commandButton value="Disconnect" actionListener="\#{chatView.disconnect}" global="false" update="container" /&gt;
        &lt;/h:panelGroup&gt;

        &lt;h:panelGroup rendered="\#{not chatView.loggedIn}" &gt;
            Username: &lt;b:inputText value="\#{chatView.username}" /&gt;

            &lt;b:spacer width="5" /&gt;
            &lt;b:commandButton value="Login" actionListener="\#{chatView.login}" update="container" 
                                icon="ui-icon-person" /&gt;
        &lt;/h:panelGroup&gt;

    &lt;/b:fieldset&gt;

    &lt;b:dialog widgetVar="pChat" header="Private Chat" modal="true" showEffect="fade" hideEffect="fade"&gt;
        &lt;h:panelGrid id="privateChatContainer" columns="2" columnClasses="vtop,vtop"&gt;
            &lt;b:outputLabel for="pChatInput" value="To: \#{chatView.privateUser}" /&gt;
            &lt;b:inputTextarea id="pChatInput" value="\#{chatView.privateMessage}" rows="5" cols="30" /&gt;

            &lt;b:spacer /&gt;
            &lt;b:commandButton value="Send" actionListener="\#{chatView.sendPrivate}" oncomplete="pChat.hide()" /&gt;
        &lt;/h:panelGrid&gt;
    &lt;/b:dialog&gt;

&lt;/h:form&gt;

&lt;b:socket onMessage="handleMessage" channel="/chat" autoConnect="false" widgetVar="subscriber"/&gt;

&lt;script type="text/javascript"&gt;
    function handleMessage(data) {
        var chatContent = $(BlazeFaces.escapeClientId('form:public'));
        chatContent.append(data + '&lt;br /&gt;');

        //keep scroll
        chatContent.scrollTop(chatContent.height());
    }
&lt;/script&gt;
                    </pre>
                </b:tab>
                
                <b:tab title="ChatView.java">
                    <pre name="code" class="java">
package com.blazebit.blazefaces.examples.view;

import javax.faces.application.FacesMessage;
import javax.faces.context.FacesContext;
import com.blazebit.blazefaces.context.RequestContext;
import com.blazebit.blazefaces.push.PushContext;
import com.blazebit.blazefaces.push.PushContextFactory;

public class ChatView {
    
    private final PushContext pushContext = PushContextFactory.getDefault().getPushContext();
    
    private ChatUsers users;

	private String privateMessage;
    
    private String globalMessage;
	
	private String username;
	
	private boolean loggedIn;
    
    private String privateUser;
    
    private final static String CHANNEL = "/chat/";

    public void setUsers(ChatUsers users) {
        this.users = users;
    }

    public String getPrivateUser() {
        return privateUser;
    }

    public void setPrivateUser(String privateUser) {
        this.privateUser = privateUser;
    }

    public String getGlobalMessage() {
        return globalMessage;
    }

    public void setGlobalMessage(String globalMessage) {
        this.globalMessage = globalMessage;
    }

    public String getPrivateMessage() {
        return privateMessage;
    }

    public void setPrivateMessage(String privateMessage) {
        this.privateMessage = privateMessage;
    }
    
	public String getUsername() {
		return username;
	}
	public void setUsername(String username) {
		this.username = username;
	}
	
	public boolean isLoggedIn() {
		return loggedIn;
	}
	public void setLoggedIn(boolean loggedIn) {
		this.loggedIn = loggedIn;
	}

	public void sendGlobal() {
        pushContext.push(CHANNEL + "*", username + ": " + globalMessage);
		
		globalMessage = null;
	}
    
    public void sendPrivate() {
        pushContext.push(CHANNEL + privateUser, "[PM] " + username + ": " + privateMessage);
        
        privateMessage = null;
    }
	
	public void login() {
        RequestContext requestContext = RequestContext.getCurrentInstance();
        
		if(users.contains(username)) {
            loggedIn = false;
            FacesContext.getCurrentInstance().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_ERROR, "Username taken", "Try with another username."));
            
            requestContext.update("growl");
        }
        else {
            users.addUser(username);
            pushContext.push(CHANNEL, username + " joined the channel.");
            requestContext.execute("subscriber.connect('/" + username + "')");
            loggedIn = true;
        }
	}
    
    public void disconnect() {
        //remove user and update ui
        users.removeUser(username);
        RequestContext.getCurrentInstance().update("form:users");
        
        //push leave information
        pushContext.push(CHANNEL, username + " left the channel.");
        
        //reset state
        loggedIn = false;
        username = null;
    }
}
                    </pre>
                </b:tab>
            </b:tabView>
		
		</div>
	</ui:define>
</ui:composition>
